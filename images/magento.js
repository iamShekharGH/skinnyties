MageMail_Magento={_originalExitButtonColor:null,_reviewId:null,_reviewStarRating:null,init:function(){this.injectCss();this.bindCaptureEmail();this.handleClicks();this.handleUnsubscribes();this.handleUnsubscribesV2();this.handleOrders();this.handleAutoLogin();this.handleReviews();this.setupExitModal();this.setupReviewModal();this.handleRestoredCart();this.handleCoupon()},injectCss:function(){this._insertBody(""+"<style type='text/css'>"+"  .mm-coupon-wrapper {"+"      background-color: rgb(34, 151, 44); "+"      padding: 0.5em; "+"      text-align: center; "+"      text-shadow: 2px 2px 1px gray; "+"      color: white; "+"      font-size: 16px;"+"   }"+"    "+"  .mm-coupon-wrapper .close {"+"      font-size: 11px; "+"      color: white; "+"      padding-left: 1em;"+"   }"+"    "+"  .mm-countdown {"+"      padding-left: 10px; "+"  } "+"    "+"  .mm-countdown .label {"+"      font-size: 13px;"+"      padding-left: 2px; "+"      padding-right: 10px; "+"  } "+"    "+"  .mm-cart-wrapper {"+"      background-color: rgb(245, 245, 218);"+"      padding: 0.5em; "+"      text-align: center; "+"      font-size: 16px; "+"  } "+"</style>"+"<!--[if IE]>"+"<style type='text/css'>"+".remodal-close::after {"+'   content: "x";'+"}"+"</style>"+"<![endif]-->")},getCountdownDate:function(){var queryString=this._getQueryString();var cookies=new MageMail_Cookies;if(queryString.mm_countdown){cookies.set("mm_countdown",queryString.mm_countdown)}if(!cookies.get("mm_countdown")){return null}if(typeof this.countdownDate=="undefined"){var expires=new Date(cookies.get("mm_countdown"));if(!expires.getTime()){return null}var now=new Date;var differenceInMilliseconds=expires.getTime()-now.getTime();var differenceSeconds=differenceInMilliseconds/1e3;if(differenceSeconds<0){return null}this.countdownDate=new Date;this.countdownDate.setTime(null);this.countdownDate.setSeconds(differenceSeconds)}return this.countdownDate},setupCountdownTimer:function(){if(typeof this.countdownDate!="undefined"){return}var self=this;var date=this.getCountdownDate();if(!date){return}setInterval(function(){var date=self.getCountdownDate();date.setSeconds(date.getSeconds()-1);var hours=(date.getUTCDate()-1)*24+date.getUTCHours();var minutes=date.getUTCMinutes();var seconds=date.getUTCSeconds();self._showElement(".mm-countdown");self._updateContent(".mm-countdown .hour",hours);self._updateContent(".mm-countdown .minute",minutes);self._updateContent(".mm-countdown .second",seconds)},1e3)},_getMageMailDomain:function(){if(typeof MageMailData.magemail_domain!="undefined"&&MageMailData.magemail_domain!=""){return MageMailData.magemail_domain}return"https://magemail.co/app"},_observe:function(element,eventName,func){if(typeof jQuery!="undefined"&&$(element)instanceof jQuery){jQuery(element).on(eventName,func)}else{Event.observe(element,eventName,func)}},_insertBody:function(html){if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){jQuery("body").prepend(html)}else{$$("body").first().childElements().first().insert({before:html})}},_addClass:function(selector,className){if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){$(selector).addClass(className)}else{$$(selector).first().addClassName(className)}return this},_removeClass:function(selector,className){if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){$(selector).removeClass(className)}else{Prototype.Selector.select(selector).first().removeClassName(className)}return this},_updateContent:function(selector,content){if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){jQuery(selector).html(content)}else{$$(selector).first().update(content)}return this},_loggingDisabled:function(){if(typeof MageMailData.javascript_logging_disabled=="undefined"){return false}return MageMailData.javascript_logging_disabled},_log:function(message){if(this._loggingDisabled()){return}if(typeof console!="undefined"){if(typeof message=="object"){console.log("[MageMail] Object: ");console.log(message)}else{console.log("[MageMail] "+message)}}},_hideElement:function(selector){if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){jQuery(selector).hide()}else{$$(selector).first().hide()}return this},_showElement:function(selector){if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){jQuery(selector).show()}else{$$(selector).first().show()}return this},_elementExists:function(selector){if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){return jQuery(selector).length}else{return $$(selector).length}},_bindEmailOnBlur:function(selector){var self=this;if(typeof jQuery!="undefined"&&$("body")instanceof jQuery){jQuery(selector).blur(function(el){self.captureEmail(el)})}else{$$(selector).each(function(element){self._observe(element,"blur",function(el){self.captureEmail(el)})})}},bindCaptureEmail:function(){var self=this;if(!MageMailData.capture_email){return}self._bindEmailOnBlur(".validate-email, #login-email, input[placeholder=E-mail]")},captureEmail:function(element){var self=this;var email=typeof element=="string"?element:element.target.value;var url="//"+MageMailData.magento_base_url+"/magemail/customer/saveCart/";this._log("Capturing email ajax request: "+url);new Ajax.Request(url,{method:"post",parameters:{email:email},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._log(data.message)},onFailure:function(){self._log("Error: Something went wrong...")}})},handleClicks:function(){var self=this;var queryString=this._getQueryString();if(queryString.mm_recipient){MageMailData.mm_recipient=decodeURIComponent(queryString.mm_recipient);MageMailData.mm_rule=queryString.mm_rule;MageMailData.mm_template=queryString.mm_template;MageMailData.mm_entity=queryString.mm_entity;var domain=this._getMageMailDomain();var url=domain+"/track/click";this._log("Click tracking ajax request: "+url);new Ajax.Request(url,{method:"get",parameters:MageMailData,onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._log(data.message);var cookies=new MageMail_Cookies;cookies.set("mm_recipient",decodeURIComponent(MageMailData.mm_recipient));cookies.set("mm_rule",MageMailData.mm_rule);cookies.set("mm_template",MageMailData.mm_template);cookies.set("mm_source_entity",MageMailData.mm_entity)},onFailure:function(){self._log("Error: Something went wrong...")}})}},handleUnsubscribes:function(){var self=this;var queryString=this._getQueryString();if(queryString.mm_unsubscribe){MageMailData.mm_recipient=decodeURIComponent(queryString.mm_recipient);MageMailData.mm_rule=queryString.mm_rule;MageMailData.mm_template=queryString.mm_template;MageMailData.mm_entity=queryString.mm_entity;var domain=this._getMageMailDomain();var separator="/";var lastChar=domain.substr(-1);if(lastChar=="/"){separator=""}new Ajax.Request(domain+separator+"track/unsubscribe",{method:"get",parameters:{mm_recipient:MageMailData.mm_recipient,mm_rule:MageMailData.mm_rule,mm_template:MageMailData.mm_template,mm_entity:MageMailData.mm_entity},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._hideElement(".magemail-customer-unsubscribe .unsubscribe .in-progress");self._updateContent(".magemail-customer-unsubscribe .unsubscribe .unsubscribe-success .email",data.email);self._showElement(".magemail-customer-unsubscribe .unsubscribe .unsubscribe-success");self._log(data.message)},onFailure:function(){self._log("Error: Something went wrong...")}})}},handleUnsubscribesV2:function(){var self=this;var queryString=this._getQueryString();var isUnsubscribe=queryString.mmv2_unsubscribe?queryString.mmv2_unsubscribe:queryString.mm2u;if(isUnsubscribe){var recipient=queryString.mm_recipient?queryString.mm_recipient:queryString.mmr;var hash=queryString.mm_reciphash?queryString.mm_reciphash:queryString.mmh;var message_id=queryString.mm_message?queryString.mm_message:queryString.mmm;new Ajax.Request("https://v2.magemail.co/unsubscribe",{method:"get",parameters:{mm_recipient:decodeURIComponent(recipient),mm_reciphash:hash,mm_message:message_id},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);if(data.success){self._hideElement(".magemail-customer-unsubscribe .unsubscribe .in-progress");self._updateContent(".magemail-customer-unsubscribe .unsubscribe .unsubscribe-success .email",data.email);self._showElement(".magemail-customer-unsubscribe .unsubscribe .unsubscribe-success");self._log(data.message)}else{alert("Uh-oh!  There was a problem unsubscribing you.  Please reply back to the email you received and ask customer support to help you.")}},onFailure:function(){alert("Uh-oh!  There was a problem unsubscribing you.  Please reply back to the email you received and ask customer support to help you.")}})}},handleOrders:function(){var self=this;if(MageMailData.mm_conversion){var cookies=new MageMail_Cookies;MageMailData.mm_recipient=cookies.get("mm_recipient");if(typeof MageMailData.mm_recipient=="undefined"||!MageMailData.mm_recipient){this.clearCookiesAndCloseCouponBar();return this}MageMailData.mm_source_entity=cookies.get("mm_source_entity");MageMailData.mm_rule=cookies.get("mm_rule");MageMailData.mm_template=cookies.get("mm_template");var domain=this._getMageMailDomain();new Ajax.Request(domain+"/track/order",{method:"get",parameters:MageMailData,onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._log(data.message)},onFailure:function(){self._log("Error: Something went wrong...")}});this.clearCookiesAndCloseCouponBar()}return this},handleCoupon:function(){var queryString=this._getQueryString();var cookies=new MageMail_Cookies;if(typeof queryString.mm_coupon!="undefined"&&queryString.mm_coupon){this.applyCouponToCart(queryString.mm_coupon,"query_string")}else if(cookies.get("mm_coupon")){this.showCouponBar();this.applyCouponToCart(cookies.get("mm_coupon"),"cookie")}},applyCouponToCart:function(coupon,source){var cookies=new MageMail_Cookies;var self=this;var url="//"+MageMailData.magento_base_url+"/magemail/customer/applyCoupon/";new Ajax.Request(url,{method:"post",parameters:{coupon:coupon,source:source},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._log(data.message);self._log(data);if(data.should_save_in_cookie){var wasCouponApplied=parseInt(cookies.get("mm_coupon_is_applied"));cookies.set("mm_coupon",coupon);cookies.set("mm_coupon_is_applied",data.is_applied?"1":"0");cookies.set("mm_coupon_label",data.rule_label);self.showCouponBar();var onCartPage=window.location.pathname.indexOf("checkout/cart")>=0;if(!wasCouponApplied&&data.is_applied&&onCartPage){self._updateContent(".mm-coupon-wrapper",self.messageReloadingForCoupon());window.location.reload()}}if(data.should_destroy_cookie){self.clearCookiesAndCloseCouponBar()}},onFailure:function(){self._log("Error: Something went wrong...")}})},clearCookiesAndCloseCouponBar:function(){var cookies=new MageMail_Cookies;cookies.set("mm_coupon","");cookies.set("mm_countdown","");cookies.set("mm_coupon_is_applied","");cookies.set("mm_coupon_label","");this.hideCouponBar();return this},handleRestoredCart:function(){var queryString=this._getQueryString();if(typeof queryString.mm_cart!="undefined"&&queryString.mm_cart){this._showRestoreCartBar();this._restoreCart();return true}return false},handleAutoLogin:function(){if(!MageMailData.auto_login){return}var queryString=this._getQueryString();if(!queryString.mm_recipient||!queryString.mm_entity){return}var self=this;var url="//"+MageMailData.magento_base_url+"/magemail/customer/autoLogin/";new Ajax.Request(url,{method:"post",parameters:queryString,onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);if(data.just_logged_in){self._log("Just logged in customer: "+data.customer_firstname)}else{self._log("Auto login wasn't successful - see Magento-side logs for the reason")}},onFailure:function(){self._log("Error: Something went wrong with auto login...")}})},_showRestoreCartBar:function(){var cartNoticeHtml="<div class='mm-cart-wrapper'></div>";this._insertBody(cartNoticeHtml);this._updateContent(".mm-cart-wrapper",this.messageUpdatingCart())},_restoreCart:function(){var self=this;var queryString=this._getQueryString();MageMailData.mm_entity=decodeURIComponent(queryString.mm_entity);var url="//"+MageMailData.magento_base_url+"/magemail/customer/restoreCart/";this._log("Restoring cart ajax request: "+url);new Ajax.Request(url,{method:"post",parameters:MageMailData,onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._log(data.message);self._updateContent(".mm-cart-wrapper",self.messageReloadingForCart());self._redirectAfterRestoringCart()},onFailure:function(){self._log("Error: Something went wrong with restoring cart.")}})},_redirectAfterRestoringCart:function(){var queryString=this._getQueryString();if(queryString.redirect){redirectUrl=decodeURIComponent(queryString.redirect)}else{redirectUrl=window.location.href.split("?")[0]}window.location=redirectUrl;return this},_transportToJson:function(transport){if(transport.responseJSON){return transport.responseJSON}if(transport.responseText){data=JSON.parse(transport.responseText);return data}return{}},showCouponBar:function(){var cookies=new MageMail_Cookies;var self=this;if(!this._elementExists(".mm-coupon-wrapper")){var closeMessage=this.messageClose();var couponBarHtml="<div class='mm-coupon-wrapper'><span class='mm-message'></span><a href='javascript://' class='close' id='mm-coupon-close'>"+closeMessage+"</a></div>";this._insertBody(couponBarHtml);this._addClass("body","mm-coupon-enabled")}var isCouponApplied=parseInt(cookies.get("mm_coupon_is_applied"));var couponBarMessage=isCouponApplied?this.couponBarMessageActivated():this.couponBarMessageNotActivated();var couponLabel=cookies.get("mm_coupon_label");if(couponLabel){couponBarMessage+=": <strong>"+couponLabel+"</strong>"}else{couponBarMessage+="."}couponBarMessage+=""+"<span class='mm-countdown' style='display: none;'>"+"   <span class='hour'></span><span class='label'>"+this.messageHoursSymbol()+"</span>"+"   <span class='minute'></span><span class='label'>m</span>"+"   <span class='second'></span><span class='label'>s</span>"+"</span>";self._updateContent(".mm-coupon-wrapper .mm-message",couponBarMessage);Event.stopObserving("mm-coupon-close","click");self._observe(document.getElementById("mm-coupon-close"),"click",function(){self.clearCookiesAndCloseCouponBar()});this.setupCountdownTimer();return this},hideCouponBar:function(){if(!this._elementExists(".mm-coupon-wrapper")){return this}this._hideElement(".mm-coupon-wrapper");return this},handleReviews:function(){var self=this;if(typeof MageMailData.review_data=="undefined"){return this}var rating=MageMailData.review_data.rating;if(!rating){this._hideElement(".mm-review .mm-loading");this._showElement(".mm-review .mm-error")._updateContent(".mm-review .mm-error .error-message","Missing a rating");return this}if(MageMailData.review_data.comment==""){MageMailData.review_data.comment="-"}var url="//"+MageMailData.magento_base_url+"/magemail/product/saveReview/";new Ajax.Request(url,{method:"post",parameters:MageMailData.review_data,onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._hideElement(".mm-review .mm-loading");if(data.success){self._showElement(".mm-review .mm-complete")}else{self._showElement(".mm-review .mm-error")._updateContent(".mm-review .mm-error .error-message",data.message)}},onFailure:function(){self._hideElement(".mm-review .mm-loading");self._showElement(".mm-review .mm-error")._updateContent(".mm-review .mm-error .error-message",self.langUnknownProblem())}});return this},setupExitModal:function(){var self=this;if(!this._shouldShowExitModal()){return}this._injectExitModalHtml();this._injectModalDependencies();window.addEventListener("load",function(){ouibounce(document.getElementById("mm-exit-modal"),{sensitivity:40,cookieExpire:90,aggressive:false,callback:function(){self.handleExitIntent()}})})},_shouldShowExitModal:function(){var queryString=this._getQueryString();var cookies=new MageMail_Cookies;if(typeof jQuery=="undefined"){return false}if(typeof MageMailData.exit_modal_enabled=="undefined"||!MageMailData.exit_modal_enabled){return false}if(queryString.mm_recipient||cookies.get("mm_recipient")){return false}return true},handleExitIntent:function(){if(typeof MageMailData.shouldHideExitModal=="function"){if(MageMailData.shouldHideExitModal()){this._log("Exit modal is hidden because of MageMailData.shouldHideExitModal");return}}var self=this;var url="//"+MageMailData.magento_base_url+"/magemail/customer/getCart/";this._log("Loading cart contents for exit modal: "+url);new Ajax.Request(url,{method:"post",parameters:{email:"test"},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);if(typeof data.cart!="undefined"&&typeof data.cart.length!="undefined"&&data.cart.length&&data.email==null){self.showCartExitModal(data)}else{self.showNewsletterExitModal(data)}self.bindExitModalForm(data)},onFailure:function(){self._log("Error: Something went wrong...")}})},showCartExitModal:function(data){this._log("Populating cart");jQuery.each(data.cart,function(id,item){var insertedItem=jQuery(".cart-contents .item-template").clone().appendTo(".cart-contents");insertedItem.removeClass("item-template").show();insertedItem.find(".name-wrapper .name").text(item.name);insertedItem.find(".image-wrapper img").attr("src",item.image_url);jQuery(".lead-in-with-cart").show();jQuery(".cart-contents-wrapper .loading").hide();jQuery(".cart-contents").removeClass("hidden").show()});this.openModal()},showNewsletterExitModal:function(){if(typeof MageMailData.newsletter_exit_modal_disabled!="undefined"&&MageMailData.newsletter_exit_modal_disabled){this._log("Not showing newsletter exit modal b/c it's disabled");return}jQuery(".lead-in-without-cart").show();jQuery(".cart-contents-wrapper .loading").hide();this.openModal()},bindExitModalForm:function(data){var self=this;$exitModal=jQuery("#mm-exit-modal");if(typeof data.email!="undefined"){$exitModal.find(".email").val(data.email)}var saveCartUrl="//"+MageMailData.magento_base_url+"/magemail/customer/saveCart/";var saveNewsletterUrl="//"+MageMailData.magento_base_url+"/magemail/customer/saveNewsletter/";var url=typeof data.cart!="undefined"&&data.cart.length>0?saveCartUrl:saveNewsletterUrl;jQuery(".mm-button-save-modal").click(function(){self.saveExitModalAjax(url)});$exitModal.keydown(function(e){var enterKeyPressed=e.which==13;if(!enterKeyPressed){return}var inputIsFocused=jQuery(this).find("input").is(":focus");if(enterKeyPressed&&inputIsFocused){e.preventDefault();self.saveExitModalAjax(url)}})},saveExitModalAjax:function(url){var self=this;$exitModal=jQuery("#mm-exit-modal");$saveButton=$exitModal.find(".mm-button-save-modal");var email=$exitModal.find("input.email").val();$exitModal.find(".error-message").text("");this._originalExitButtonColor=$saveButton.css("background-color");$saveButton.css("background-color","#B5B5B5");new Ajax.Request(url,{method:"post",parameters:{email:email,source:"magemail_exit_modal"},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);if(data.success){if(typeof data.existing_subscriber_id=="undefined"||data.existing_subscriber_id==null){self.exitModalFormSaved(data)}else{self.exitModalFormError(data)}}else{self.exitModalFormError(data)}},onFailure:function(){self._log("Error: Something went wrong...");self.exitModalFormError({message:self.lang("network_problem_couldnt_save_email")})}})},exitModalFormSaved:function(data){var self=this;var exitModalSelector=jQuery("#mm-exit-modal");exitModalSelector.find(".success-message").text(self.lang("thanks_you_will_receive_email"));exitModalSelector.find(".message-wrapper").show();if(typeof data.existing_subscriber_id!="undefined"){self.sendNewsletterTrigger()}setTimeout(function(){self.closeModal()},2e3)},sendNewsletterTrigger:function(){var self=this;var domain=this._getMageMailDomain();var username=MageMailData.username;new Ajax.Request(domain+"/api/send-newsletter",{method:"post",parameters:{username:username},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._log(data)},onFailure:function(){self._log("Error: Something went wrong...")}})},exitModalFormError:function(data){var $exitModal=jQuery("#mm-exit-modal");$exitModal.find(".mm-button-save-modal").css("background-color",this._originalExitButtonColor);$exitModal.find(".error-message").text(data.message);$exitModal.find(".message-wrapper").show()},openModal:function(){var remodal=jQuery.remodal.lookup[jQuery("[data-remodal-id=mm-exit-modal]").data("remodal")];remodal.open()},closeModal:function(){var remodal=jQuery.remodal.lookup[jQuery("[data-remodal-id=mm-exit-modal]").data("remodal")];remodal.close()},_injectExitModalHtml:function(){if(jQuery("#mm-exit-modal").length>0){this._log("Remodal div already exists, not going to inject");return}jQuery("body").append('<div data-remodal-id="mm-exit-modal" id="mm-exit-modal" style="display: none;">'+"    <h1>"+this.lang("before_you_leave")+"</h1>"+'    <div class="cart-contents-wrapper">'+'        <p class="loading">'+this.lang("loading")+"</p>"+'        <div class="cart-contents hidden" style="display: none;">'+'            <div class="item item-template" style="display: none;">'+'                <div class="image-wrapper">'+'                    <img src="">'+"                </div>"+'                <div class="name-wrapper">'+'                    <span class="name">Template</span>'+"                </div>"+"            </div>"+"        </div>"+"    </div>"+'    <p class="lead-in-with-cart" style="display: none;">'+this.lang("enter_email_to_have_cart_emailed")+"</p>"+'    <p class="lead-in-without-cart" style="display: none;">'+this.lang("enter_email_to_receive_newsletter")+"</p>"+'    <div class="input-wrapper">'+'        <input type="text" class="email" placeholder="you@yoursite.com">'+'        <a class="mm-button-save-modal" href="javascript://">'+this.lang("save_exit_modal_button")+"</a>"+"    </div>"+'    <div class="message-wrapper" style="display: none;">'+'        <p class="success-message"></p>'+'        <p class="error-message"></p>'+"    </div>"+'    <div class="no-thanks">'+'        <a href="javascript:MageMail_Magento.closeModal();">'+this.lang("no_thanks")+"</a>"+"    </div>"+"</div>")},_injectModalDependencies:function(){var self=this;var domain=this._getMageMailDomain();var jqueryRemodalJsUrl=typeof MageMailData.jquery_remodal_js_url=="string"?MageMailData.jquery_remodal_js_url:domain+"/skin/js/jquery.remodal.min.js";var jqueryRemodalCssUrl=typeof MageMailData.jquery_remodal_css_url=="string"?MageMailData.jquery_remodal_css_url:domain+"/skin/js/jquery.remodal.css";var ouibounceJsUrl=typeof MageMailData.ouibounce_js_url=="string"?MageMailData.ouibounce_js_url:domain+"/skin/js/ouibounce.js";var exitModalCssUrl=typeof MageMailData.exit_modal_css_url=="string"?MageMailData.exit_modal_css_url:domain+"/skin/css/exit-modal.css";if(jQuery('head link[href="'+jqueryRemodalJsUrl+'"]').length>0){return}jQuery("head").append('<script type="text/javascript" src="'+ouibounceJsUrl+'" />').append('<link rel="stylesheet" href="'+exitModalCssUrl+'" type="text/css" />').append('<link rel="stylesheet" href="'+jqueryRemodalCssUrl+'" type="text/css" />');jQuery.ajax({url:jqueryRemodalJsUrl,dataType:"script",cache:true,success:function(){self._afterModalDependenciesInjected()}})},_afterModalDependenciesInjected:function(){var queryString=this._getQueryString();jQuery("[data-remodal-id=mm-exit-modal]").remodal({hashTracking:false});if(typeof queryString.mmrv!="undefined"){setTimeout(function(){jQuery("[data-remodal-id=mm-review-modal]").show().remodal({hashTracking:false}).open()},1e3)}},setupReviewModal:function(){var self=this;var queryString=this._getQueryString();if(typeof queryString.mmrv=="undefined"){return}this._saveInitialRating();this._injectModalDependencies();var username=MageMailData.username;jQuery("head").append('<link rel="stylesheet" href="https://v2.magemail.co/css/user/'+username+'.css"'+'" type="text/css" />');jQuery.ajax({url:"https://v2.magemail.co/js/user/"+username+".js",dataType:"script",success:function(){self.appendReviewHtml();self.bindReviewForm();self.reviewRefreshStars()}})},_saveInitialRating:function(){var self=this;var url="//"+MageMailData.magento_base_url+"/magemail/product/saveReview/";var queryString=this._getQueryString();if(!queryString.mmr){return}this._reviewStarRating=queryString.mmrv;new Ajax.Request(url,{method:"post",parameters:{rating:queryString.mmrv,email:decodeURIComponent(queryString.mmr),token:queryString.mmrt,nickname:queryString.mmrn,product_id:queryString.mmpi},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);if(data.success){self._reviewId=data.review_id}else{self._setReviewStatus(self.lang("there_was_a_problem_saving_review"),"error")}},onFailure:function(){self._setReviewStatus(self.lang("there_was_a_problem_saving_review"),"error")}})},_setReviewStatus:function(message,status){this._updateContent(".mm-review-status",message);this._addClass(".mm-review-status",status)},appendReviewHtml:function(){var queryString=this._getQueryString();var product_name=typeof queryString.mmpn!="undefined"?decodeURIComponent(queryString.mmpn):"";var nick_name=typeof queryString.mmrn!="undefined"?queryString.mmrn:"";var product_id=queryString.mmpi;var product_image_url="//"+MageMailData.magento_base_url+"/magemail/product/image/product_id/"+product_id+"/width/600/height/600/image_type/small_image/";jQuery("body").append('<div data-remodal-id="mm-review-modal" id="mm-review-modal" style="display: none;">'+'    <div class="mm-review-wrapper">'+'        <h1 class="mm-review-title">'+product_name+"</h1>"+"        <p>"+this.lang("please_add_comments_to_review")+"</p>"+'        <div class="mm-review-image-wrapper">'+'           <img src="'+product_image_url+'">'+"        </div>"+'        <form class="mm-review-form">'+'            <div class="mm-star-rating">'+'                <img data-rating="1" src="http://magemail.co/app/skin/images/rating-star.gif">'+'                <img data-rating="2" src="http://magemail.co/app/skin/images/rating-star.gif">'+'                <img data-rating="3" src="http://magemail.co/app/skin/images/rating-star.gif">'+'                <img data-rating="4" src="http://magemail.co/app/skin/images/rating-star.gif">'+'                <img data-rating="5" src="http://magemail.co/app/skin/images/rating-star.gif">'+"            </div>"+'            <div class="mm-nickname">'+'                <label for="mm-nickname">'+this.lang("your_nickname")+"</label>"+'                <input type="text" id="mm-nickname" name="mm_nickname" value="'+nick_name+'" />'+"            </div>"+'            <div class="mm-summary">'+'                <label for="mm-summary">'+this.lang("summary_of_your_review")+"</label>"+'                <input type="text" id="mm-summary" name="mm_summary" />'+"            </div>"+'            <div class="mm-thoughts">'+'                <label for="mm-thoughts">'+this.lang("review_let_us_know_your_thoughts")+"</label>"+'                <textarea id="mm-thoughts" name="mm_thoughts"></textarea>'+"            </div>"+"        </form>"+"    </div>"+'    <div class="save-review-wrapper">'+'        <a class="mm-review-button" href="javascript://">'+this.lang("save_review")+"</a>"+"    </div>"+'    <div class="mm-review-status">'+"    </div>"+"</div>")},bindReviewForm:function(){var self=this;var queryString=this._getQueryString();jQuery(".mm-star-rating img").click(function(){self._reviewStarRating=jQuery(this).attr("data-rating");self.reviewRefreshStars()});var url="//"+MageMailData.magento_base_url+"/magemail/product/saveReview/";jQuery(".mm-review-button").click(function(){self._addClass(".mm-review-button","submitting");self._updateContent(".mm-review-button",self.lang("just_a_moment"));new Ajax.Request(url,{method:"post",parameters:{review_id:self._reviewId,rating:self._reviewStarRating,product_id:queryString.mmpi,email:decodeURIComponent(queryString.mmr),token:queryString.mmrt,comment:jQuery("#mm-thoughts").val(),title:jQuery("#mm-summary").val(),nickname:jQuery("#mm-nickname").val()},onCreate:self.fixAjaxRequestHeader,onSuccess:function(transport){var data=self._transportToJson(transport);self._removeClass(".mm-review-button","submitting");self._updateContent(".mm-review-button",self.lang("save_review"));if(data.success){self._setReviewStatus(self.lang("your_review_was_saved"),"success");setTimeout(function(){var remodal=jQuery.remodal.lookup[jQuery("[data-remodal-id=mm-review-modal]").data("remodal")];remodal.close()},2e3)}else{self._setReviewStatus(self.lang("there_was_a_problem_saving_review"),"error")}},onFailure:function(){self._setReviewStatus(self.lang("there_was_a_problem_saving_review"),"error")}})})},reviewRefreshStars:function(){for(i=1;i<=5;i++){var uncheckedImageSrc="https://v2.magemail.co/image/email/icon-star.png";var checkedImageSrc="http://magemail.co/app/skin/images/rating-star.gif";if(this._reviewStarRating>=i){jQuery(".mm-star-rating img:nth-child("+i+")").attr("src",checkedImageSrc)}else{jQuery(".mm-star-rating img:nth-child("+i+")").attr("src",uncheckedImageSrc)}}},fixAjaxRequestHeader:function(response){var t=response.transport;t.setRequestHeader=t.setRequestHeader.wrap(function(original,k,v){if(/^(accept|accept-language|content-language)$/i.test(k))return original(k,v);if(/^content-type$/i.test(k)&&/^(application\/x-www-form-urlencoded|multipart\/form-data|text\/plain)(;.+)?$/i.test(v))return original(k,v);return this})},_getQueryString:function(){var query_string={};var query=window.location.search.substring(1);var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(typeof query_string[pair[0]]==="undefined"){query_string[pair[0]]=pair[1]}else if(typeof query_string[pair[0]]==="string"){arr=[query_string[pair[0]],pair[1]];query_string[pair[0]]=arr}else{query_string[pair[0]].push(pair[1])}}return query_string},couponBarMessageNotActivated:function(){if(typeof MageMailData.coupon_bar_message_not_activated!="undefined"){return MageMailData.coupon_bar_message_not_activated}return"Add items to your cart to activate your discount"},couponBarMessageActivated:function(){if(typeof MageMailData.coupon_bar_message_activated!="undefined"){return MageMailData.coupon_bar_message_activated}return"You've activated a discount.  Checkout now to redeem it"},messageUpdatingCart:function(){if(typeof MageMailData.message_updating_cart!="undefined"){return MageMailData.message_updating_cart}return"Just a moment, we're updating your cart..."},messageReloadingForCoupon:function(){if(typeof MageMailData.message_reloading_for_coupon!="undefined"){return MageMailData.message_reloading_for_coupon}return"Just a moment.  Reloading the page to apply your coupon..."},messageReloadingForCart:function(){if(typeof MageMailData.message_reloading_for_cart!="undefined"){return MageMailData.message_reloading_for_cart}return"Done updating the cart, reloading the page now..."},messageClose:function(){if(typeof MageMailData.message_close!="undefined"){return MageMailData.message_close}return"close"},messageHoursSymbol:function(){if(typeof MageMailData.message_hours_symbol!="undefined"){return MageMailData.message_hours_symbol}return"h"},lang:function(languageKey){if(typeof MageMailData["lang_"+languageKey]!="undefined"){return MageMailData["lang_"+languageKey]}return languageKey},langUnknownProblem:function(){return typeof MageMailData.lang_unknown_problem!="undefined"?MageMailData.lang_unknown_problem:"There was an unknown problem"
}};var MageMail_Cookies=Class.create({initialize:function(path,domain){this.path=path||"/";this.domain=domain||null},set:function(key,value,days){if(typeof key!="string"){throw"Invalid key"}if(typeof value!="string"&&typeof value!="number"){throw"Invalid value"}if(days&&typeof days!="number"){throw"Invalid expiration time"}var setValue=key+"="+escape(String(value));var setExpiration;if(days){var date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);setExpiration="; expires="+date.toGMTString()}else setExpiration="";var setPath="; path="+escape(this.path);var setDomain=this.domain?"; domain="+escape(this.domain):"";document.cookie=setValue+setExpiration+setPath+setDomain},get:function(key){var keyEquals=key+"=";var value=false;document.cookie.split(";").invoke("strip").each(function(s){if(s.startsWith(keyEquals)){value=unescape(s.substring(keyEquals.length,s.length));throw $break}});return value},clear:function(key){this.set(key,"",-1)}});if(typeof MageMailData=="object"&&typeof MageMailData.beforeInit=="function"){MageMail_Magento._log("Running beforeInit");MageMailData.beforeInit()}MageMail_Magento.init();if(typeof MageMailData=="object"&&typeof MageMailData.afterInit=="function"){MageMail_Magento._log("Running afterInit");MageMailData.afterInit()}